# 스팸 필터링 방안 (A Plan for Spam)

만드는 것을 좋아하세요? Hacker News를 방문해 보세요.

2002년 8월

(이 글은 저희가 Arc[1]를 시험하기 위해 만든, 스팸 방지 웹 기반 메일 리더에 사용된 스팸 필터링 기술을 설명합니다. 개선된 알고리즘은 ‘더 나은 베이즈 필터링(Better Bayesian Filtering)’에 설명되어 있습니다.)

저는 스팸을 막는 것이 가능하며, 콘텐츠 기반 필터가 그 방법이라고 생각합니다.
스패머들의 아킬레스건은 그들의 메시지입니다.
그들은 당신이 설정한 다른 어떤 장벽도 피할 수 있습니다. 적어도 지금까지는 그랬습니다. 하지만 그들은 메시지가 무엇이든 전달해야 합니다. 만약 우리가 그들의 메시지를 인식하는 소프트웨어를 만들 수 있다면, 그들은 그것을 피할 방법이 없을 것입니다.
---
수신자에게 스팸은 쉽게 알아볼 수 있습니다. 당신이 누군가를 고용해 메일을 읽고 스팸을 버리게 한다면, 그들은 거의 문제없이 그렇게 할 것입니다. AI(인공지능)까지는 아니더라도, 이 과정을 자동화하기 위해 얼마나 많은 일을 해야 할까요?

저는 우리가 비교적 간단한 알고리즘으로 이 문제를 해결할 수 있을 것이라고 생각합니다. 실제로 저는 개별 단어의 스팸 확률을 베이즈 조합(Bayesian combination)하는 것만으로도 현재의 스팸을 충분히 잘 필터링할 수 있다는 것을 발견했습니다. 아래에 설명된 대로 약간 수정된 베이즈 필터를 사용하면, 이제 스팸 차단율은 99.5% 이상이고, 오탐율(false positive rate)은 0%입니다.

통계적 접근 방식은 사람들이 스팸 필터를 작성할 때 보통 처음 시도하는 방식이 아닙니다. 대부분의 해커들은 스팸의 개별 속성을 인식하는 소프트웨어를 작성하려고 시도하는 것이 첫 번째 본능입니다. 스팸을 보면 이런 생각이 듭니다. '이 사람들, 감히 "Dear Friend"로 시작하거나, 전부 대문자로 되어 있고 느낌표가 여덟 개로 끝나는 제목을 가진 메일을 나한테 보내다니.' 저는 이런 것들을 한 줄짜리 코드 한 줄로 걸러낼 수 있습니다.

그래서 그렇게 합니다. 처음에는 효과가 있습니다. 몇 가지 간단한 규칙만으로도 들어오는 스팸의 큰 부분을 걸러낼 수 있습니다. 단순히 "click"이라는 단어를 찾는 것만으로도 제 스팸 말뭉치(corpus)에 있는 이메일의 79.7%를 잡아낼 수 있으며, 오탐율은 1.2%에 불과합니다.

저는 통계적 접근 방식을 시도하기 전에 스팸의 개별적인 특징을 찾는 소프트웨어를 작성하는 데 약 6개월을 보냈습니다. 제가 발견한 것은 마지막 몇 퍼센트의 스팸을 인식하는 것이 매우 어려워졌고, 필터를 더 엄격하게 만들수록 오탐이 더 많이 발생한다는 것이었습니다.

오탐(false positives)은 스팸으로 오인된 무해한 이메일입니다.
대부분의 사용자에게는 정당한 이메일을 놓치는 것이 스팸을 받는 것보다 훨씬 더 심각합니다. 따라서 오탐을 발생시키는 필터는 환자에게 사망 위험이 있는 여드름 치료제와 같습니다.

사용자가 스팸을 많이 받을수록 스팸 폴더에 있는 하나의 무해한 메일을 알아차릴 가능성은 낮아집니다. 그리고 이상하게도 스팸 필터가 좋아질수록 오탐은 더 위험해집니다. 필터가 정말 좋으면 사용자는 필터가 잡아내는 모든 것을 무시할 가능성이 높아지기 때문입니다.

제가 왜 그렇게 오랫동안 통계적 접근 방식을 시도하지 않았는지 모르겠습니다. 스패머들과 경쟁하는 일종의 게임을 하는 것처럼 스팸 특징을 직접 식별하려고 중독되었기 때문인 것 같습니다. (비(非)해커들은 이것을 잘 모르지만, 대부분의 해커들은 매우 경쟁적입니다.)

통계 분석을 시도했을 때, 저는 곧바로 그것이 저보다 훨씬 똑똑하다는 것을 알게 되었습니다. 물론 "virtumundo"나 "teens"와 같은 용어가 스팸의 좋은 지표임을 발견했습니다. 하지만 "per", "FL", "ff0000"도 스팸의 좋은 지표라는 것을 발견했습니다. 사실 "ff0000"(밝은 빨간색을 나타내는 HTML 코드)은 어떤 포르노 용어만큼이나 스팸의 좋은 지표로 밝혀졌습니다.
---
제가 통계 필터링을 하는 방법의 개요는 다음과 같습니다. 저는 스팸 말뭉치 하나와 비(非)스팸 메일 말뭉치 하나로 시작합니다. 현재 각각 약 4000개의 메시지가 있습니다. 저는 각 말뭉치의 각 메시지에 있는 전체 텍스트(헤더, 포함된 HTML 및 자바스크립트 포함)를 스캔합니다.

저는 현재 영숫자 문자, 대시, 아포스트로피, 달러 기호를 토큰의 일부로 간주하고, 나머지는 모두 토큰 분리자로 간주합니다. (여기에는 개선의 여지가 있을 수 있습니다.) 저는 모든 숫자로만 구성된 토큰은 무시하고, HTML 주석도 토큰 분리자로 간주하지 않습니다.

저는 각 말뭉치에서 각 토큰(현재는 대소문자 무시)이 발생하는 횟수를 셉니다. 이 단계에서 저는 토큰을 발생 횟수에 매핑하는 두 개의 큰 해시 테이블(각 말뭉치마다 하나씩)을 얻게 됩니다.

다음으로 세 번째 해시 테이블을 만듭니다. 이번에는 각 토큰을 해당 토큰을 포함하는 이메일이 스팸일 확률에 매핑하는데, 이는 다음과 같이 계산합니다[1].
```lisp
(let ((g (* 2 (or (gethash word good) 0)))
      (b (or (gethash word bad) 0)))
   (unless (< (+ g b) 5)
     (max .01
          (min .99 (float (/ (min 1 (/ b nbad))
                             (+ (min 1 (/ g ngood))   
                                (min 1 (/ b nbad)))))))))
```
여기서
`word`는 우리가 확률을 계산하는 토큰이고,
`good`과 `bad`는 첫 번째 단계에서 만든 해시 테이블이며,
`ngood`와 `nbad`는 각각 비스팸 메일과 스팸 메시지의 수입니다.
제가 코드로 설명한 이유는 몇 가지 중요한 세부 사항을 보여주기 위해서입니다.
저는 오탐을 피하기 위해 확률에 약간의 편향(bias)을 주고자 하며, 시행착오를 통해 `good`의 모든 숫자를 두 배로 늘리는 것이 좋은 방법이라는 것을 발견했습니다.
이것은 합법적인 이메일에도 가끔 나타나는 단어와 거의 나타나지 않는 단어를 구별하는 데 도움이 됩니다. 저는 총 다섯 번 이상 나타나는 단어만 고려합니다(실제로 두 배로 늘렸기 때문에 비스팸 메일에 세 번 나타나도 충분합니다). 그리고 한 말뭉치에는 나타나지만 다른 말뭉치에는 나타나지 않는 단어에 어떤 확률을 할당할 것인가 하는 문제가 있습니다. 다시 시행착오를 통해 .01과 .99를 선택했습니다. 여기에는 조정의 여지가 있을 수 있지만, 말뭉치가 커지면 그런 조정은 어차피 자동으로 일어날 것입니다.

특히 관찰력이 좋은 분들은 제가 발생 횟수를 세는 목적으로는 각 말뭉치를 하나의 긴 텍스트 스트림으로 간주하지만, 스팸 확률을 계산할 때 제수로 사용되는 것은 말뭉치의 전체 길이가 아니라 각 말뭉치의 이메일 수라는 것을 알아차리실 것입니다. 이는 오탐을 방지하기 위한 또 다른 약간의 편향을 추가합니다.

새로운 메일이 도착하면 토큰으로 스캔되고, 중립적인 .5에서 스팸 확률이 얼마나 떨어져 있는지를 기준으로 흥미로운 15개 토큰이 메일이 스팸일 확률을 계산하는 데 사용됩니다. `probs`가 15개 개별 확률의 목록이라면, `combined` 확률은 다음과 같이 계산합니다.
```lisp
(let ((prod (apply #'* probs)))
  (/ prod (+ prod (apply #'* (mapcar #'(lambda (x) 
                                         (- 1 x))
                                     probs)))))
```
실제로 발생하는 한 가지 질문은 한 번도 본 적이 없는 단어, 즉 단어 확률 해시 테이블에 없는 단어에 어떤 확률을 할당해야 하는지입니다. 저는 다시 시행착오를 통해 .4가 좋은 숫자라는 것을 발견했습니다. 이전에 한 번도 본 적이 없는 단어는 아마도 상당히 무해할 것입니다. 스팸 단어는 너무나 익숙한 경향이 있습니다.

이 알고리즘이 실제 이메일에 적용된 예시는 부록에 있습니다.
저는 위 알고리즘이 스팸일 확률이 .9를 넘으면 메일을 스팸으로 취급합니다. 하지만 실제로는 이 임계값을 어디에 두든 크게 상관없을 것입니다. 왜냐하면 중간 범위의 확률이 나오는 경우는 거의 없기 때문입니다.
---
통계적 접근 방식의 큰 장점 중 하나는 스팸을 그렇게 많이 읽을 필요가 없다는 것입니다. 지난 6개월 동안 저는 말 그대로 수천 개의 스팸을 읽었는데, 정말 기운이 빠지는 일이었습니다. 노버트 위너(Norbert Wiener)는 노예와 경쟁하면 노예가 된다고 했는데, 스패머와 경쟁하는 것도 비슷하게 모욕적인 일이 있습니다. 개별 스팸 특징을 인식하려면 스패머의 마음속으로 들어가야 하는데, 솔직히 저는 스패머의 마음속에서 가능한 한 적은 시간을 보내고 싶습니다.

하지만 베이즈 접근 방식의 진정한 장점은 물론, 무엇을 측정하고 있는지 안다는 것입니다. 스팸어쌔신(SpamAssassin)과 같은 특징 인식 필터는 이메일에 스팸 "점수(score)"를 할당합니다. 베이즈 접근 방식은 실제 확률을 할당합니다. "점수"의 문제는 아무도 그것이 무엇을 의미하는지 모른다는 것입니다. 사용자는 그것이 무엇을 의미하는지 모르고, 더 나쁜 것은 필터 개발자도 모른다는 것입니다. "sex"라는 단어가 포함된 이메일은 몇 "점"을 받아야 할까요? 확률은 물론 틀릴 수도 있지만, 그것이 무엇을 의미하는지, 또는 증거를 결합하여 어떻게 계산해야 하는지에 대한 모호함은 거의 없습니다. 제 말뭉치를 기준으로 "sex"는 해당 이메일이 스팸일 확률이 .97임을 나타내고, "sexy"는 .99 확률을 나타냅니다.

그리고 베이즈 정리(Bayes' Rule)는 마찬가지로 모호하지 않게, (가능성은 낮지만) 다른 증거가 없는 경우 두 단어를 모두 포함하는 이메일은 스팸일 확률이 99.97%라고 말합니다.

확률을 측정하기 때문에 베이즈 접근 방식은 이메일에 있는 모든 증거, 즉 좋은 것과 나쁜 것을 모두 고려합니다. 스팸에서 불균형적으로 드물게 나타나는 단어(예: "though", "tonight", "apparently")는 "unsubscribe"나 "opt-in"과 같은 나쁜 단어가 확률을 높이는 것만큼 확률을 낮추는 데 기여합니다. 따라서 "sex"라는 단어가 우연히 포함된 무해한 이메일은 스팸으로 태그되지 않을 것입니다.

이상적으로는 물론, 확률은 각 사용자에게 개별적으로 계산되어야 합니다. 저는 "Lisp"이라는 단어가 포함된 이메일을 많이 받는데, (아직까지는) 그런 스팸은 없습니다. 따라서 그런 단어는 저에게 메일을 보내는 일종의 비밀번호와 같습니다. 이전 스팸 필터링 소프트웨어에서는 사용자가 그런 단어 목록을 설정할 수 있었고, 해당 단어가 포함된 메일은 필터를 자동으로 통과했습니다. 제 목록에는 "Lisp"와 같은 단어와 우편번호도 넣어서, (그렇지 않으면 꽤 스팸처럼 들리는) 온라인 주문 영수증이 통과되도록 했습니다. 제가 매우 영리하다고 생각했지만, 베이즈 필터가 저를 위해 똑같은 일을 해주었을 뿐만 아니라, 제가 생각하지 못했던 많은 단어들을 발견해주었습니다.

제가 처음에 필터가 1000개당 5개 미만의 스팸을 놓치고 오탐이 0이라고 말했을 때, 그것은 제 메일 말뭉치를 기반으로 제 메일을 필터링하는 것을 의미합니다. 하지만 이 수치들은 오해를 불러일으키지 않습니다. 왜냐하면 제가 주장하는 접근 방식은 다음과 같기 때문입니다. 각 사용자의 메일을 그가 받는 스팸 및 비스팸 메일을 기반으로 필터링합니다. 기본적으로 각 사용자는 일반 삭제 버튼과 스팸으로 삭제 버튼 두 개를 가져야 합니다. 스팸으로 삭제된 모든 것은 스팸 말뭉치로 들어가고, 나머지는 모두 비스팸 말뭉치로 들어갑니다.

사용자에게 시드(seed) 필터를 제공하여 시작할 수 있지만, 궁극적으로 각 사용자는 자신이 받는 실제 메일을 기반으로 자신만의 단어별 확률을 가져야 합니다. 이는 (a) 필터를 더 효과적으로 만들고, (b) 각 사용자가 스팸의 자신만의 정확한 정의를 결정할 수 있게 하며, (c) 아마도 가장 중요한 것은 스패머가 필터를 통과하도록 메일을 조정하기 어렵게 만듭니다. 필터의 많은 부분이 개별 데이터베이스에 있다면, 시드 필터를 통과하도록 스팸을 조정하는 것만으로는 개별 사용자의 다양하고 훨씬 더 잘 훈련된 필터를 얼마나 잘 통과할지에 대해 아무것도 보장하지 못할 것입니다.

콘텐츠 기반 스팸 필터링은 종종 화이트리스트(whitelist)와 결합됩니다. 화이트리스트는 필터링 없이 메일을 수락할 수 있는 발신자 목록입니다. 이러한 화이트리스트를 구축하는 쉬운 방법 중 하나는 사용자가 메일을 보낸 모든 주소 목록을 유지하는 것입니다. 메일 리더에 스팸으로 삭제 버튼이 있다면, 사용자가 일반 쓰레기로 삭제한 모든 이메일의 발신 주소도 추가할 수 있습니다.

저는 화이트리스트를 지지하지만, 필터링을 개선하는 방법이라기보다는 연산을 절약하는 방법으로서 더 그렇습니다. 저는 화이트리스트가 필터링을 더 쉽게 만들 것이라고 생각했습니다. 왜냐하면 이전에 들어본 적 없는 사람들의 이메일만 필터링하면 되고, 처음으로 메일을 보내는 사람은 그들이 당신에게 말할 수 있는 것에 대해 관습에 의해 제약을 받기 때문입니다. 이미 아는 사람은 섹스에 대해 이야기하는 이메일을 보낼 수도 있지만, 처음으로 메일을 보내는 사람은 그럴 가능성이 낮을 것입니다. 문제는 사람들이 여러 개의 이메일 주소를 가질 수 있다는 것입니다. 따라서 새로운 발신 주소가 발신자가 당신에게 처음으로 글을 쓰는 것을 보장하지는 않습니다.
오랜 친구(특히 해커라면)가 갑자기 새로운 발신 주소로 이메일을 보내는 것은 드문 일이 아니므로, 알 수 없는 주소에서 온 메일을 특히 엄격하게 필터링하여 오탐의 위험을 감수할 수는 없습니다.

어떤 의미에서는 제 필터 자체가 일종의 화이트리스트(및 블랙리스트)를 포함하고 있습니다. 왜냐하면 헤더를 포함한 전체 메시지를 기반으로 하기 때문입니다. 따라서 그들은 신뢰할 수 있는 발신자의 이메일 주소는 물론 메일이 그들로부터 저에게 도달하는 경로까지 "알고" 있습니다. 그리고 그들은 서버 이름, 메일러 버전, 프로토콜을 포함하여 스팸에 대해서도 동일한 것을 알고 있습니다.
---
만약 제가 현재의 스팸 필터링 속도를 유지할 수 있다고 생각했다면, 이 문제가 해결되었다고 간주했을 것입니다. 하지만 현재의 스팸 대부분을 필터링할 수 있다는 것은 큰 의미가 없습니다. 스팸은 진화하기 때문입니다.

실제로 지금까지의 대부분의 스팸 방지 기술은 해충의 새로운 저항성 변종을 만들어내는 살충제와 같았습니다.
저는 베이즈 필터에 더 희망을 걸고 있습니다. 스팸과 함께 진화하기 때문입니다. 따라서 스패머가 개별 단어를 기반으로 하는 단순한 스팸 필터를 회피하기 위해 "cock" 대신 "c0ck"을 사용하기 시작하면 베이즈 필터는 자동으로 이를 알아차립니다. 실제로 "c0ck"은 "cock"보다 훨씬 더 치명적인 증거이며, 베이즈 필터는 얼마나 더 그런지 정확히 알고 있습니다.

그럼에도 불구하고 스팸 필터링 계획을 제안하는 사람은 다음과 같은 질문에 답할 수 있어야 합니다. 스패머가 당신이 하는 일을 정확히 안다면, 얼마나 잘 당신을 통과할 수 있을까요? 예를 들어, 체크섬(checksum) 기반 스팸 필터링이 심각한 장애물이 된다면, 스패머는 메시지 본문을 생성하기 위해 매드 리브(mad-lib) 기술로 전환할 것이라고 생각합니다.

베이즈 필터를 이기려면 스패머는 이메일을 고유하게 만들거나 개별적인 불량 단어 사용을 중단하는 것만으로는 충분하지 않을 것입니다. 그들은 자신들의 메일을 당신의 일반 메일과 구별할 수 없게 만들어야 할 것입니다. 그리고 이것이 그들을 심각하게 제약할 것이라고 생각합니다. 스팸은 대부분 판매 홍보이므로, 당신의 일반 메일이 모두 판매 홍보가 아니라면, 스팸은 필연적으로 다른 특징을 가질 것입니다. 물론 스패머는 전체 인프라(infrastructure)를 변경하고 계속 변경해야 할 것입니다. 그렇지 않으면 메시지 본문에 어떤 조치를 취하든 헤더는 베이즈 필터에 여전히 나쁘게 보일 것입니다. 스패머가 사용하는 인프라에 대해 충분히 알지 못하여 헤더를 무해하게 보이게 만드는 것이 얼마나 어려울지 모르겠지만, 제 생각에는 메시지를 무해하게 보이게 만드는 것보다 훨씬 더 어려울 것입니다.

헤더 문제를 해결할 수 있다고 가정하면, 미래의 스팸은 아마도 다음과 같은 형태를 띨 것입니다.
> 안녕하세요. 다음 링크를 확인해 보세요:
> http://www.27meg.com/foo
왜냐하면 콘텐츠 기반 필터링이 스패머에게 허용할 수 있는 판매 홍보의 한계가 그 정도이기 때문입니다. (실제로 이조차도 필터를 통과하기 어려울 것입니다. 이메일의 다른 모든 것이 중립적이라면 스팸 확률은 URL에 달려 있을 것이고, 그것을 중립적으로 보이게 하려면 상당한 노력이 필요할 것입니다.)

스패머는 소위 옵트인(opt-in) 목록을 운영하며 자신의 신원을 숨기려 하지 않는 기업부터, 포르노 사이트를 홍보하는 스팸을 보내기 위해 메일 서버를 탈취하는 사람까지 다양합니다. 만약 우리가 필터링을 사용하여 그들의 선택지를 위와 같은 메일로 제한한다면, 스팸 스펙트럼의 "합법적인" 끝에 있는 스패머들은 사업을 접어야 할 것입니다. 그들은 다양한 주 법률에 의해 자신의 스팸이 왜 스팸이 아닌지, 그리고 "구독"을 취소하는 방법을 포함하는 상투적인 문구를 포함할 의무가 있는데, 그런 종류의 텍스트는 쉽게 인식할 수 있습니다.
(저는 더 엄격한 법률이 스팸을 줄일 것이라고 믿는 것이 순진하다고 생각했습니다. 이제는 더 엄격한 법률이 스패머가 보내는 스팸의 양을 줄이지는 못하더라도, 수신자가 실제로 보는 스팸의 양을 필터가 줄이는 데 확실히 도움이 될 수 있다고 생각합니다.)

스펙트럼 전체에 걸쳐, 스패머가 할 수 있는 판매 홍보를 제한한다면, 그들은 필연적으로 사업을 접을 수밖에 없을 것입니다. "사업(business)"이라는 단어는 기억해야 할 중요한 단어입니다. 스패머는 사업가입니다. 그들은 스팸을 보냅니다. 왜냐하면 효과가 있기 때문입니다. 응답률은 터무니없이 낮지만(카탈로그 메일의 경우 100만분의 3000에 비해 기껏해야 100만분의 15), 그들에게 드는 비용은 거의 없기 때문에 효과가 있습니다. 비용은 수신자에게는 엄청납니다. 스팸을 삭제하는 데 1초를 쓰는 100만 명의 수신자당 약 5인주(man-weeks)가 소요되지만, 스패머는 그 비용을 지불할 필요가 없습니다.

스팸을 보내는 데 스패머에게도 비용이 듭니다[2]. 따라서 응답률을 낮출 수 있는 만큼 낮출수록(필터링을 통해서든, 필터를 사용하여 스패머가 홍보 내용을 희석하도록 강요함으로써든), 스팸을 보내는 것이 가치 있다고 생각하는 기업은 줄어들 것입니다.

스패머가 사용하는 판매 홍보 방식은 응답률을 높이기 위한 것입니다.
이것은 스패머의 마음속으로 들어가는 것보다 훨씬 더 역겨울 수 있지만, 스팸에 `응답하는` 사람의 마음속을 잠시 들여다보겠습니다. 이 사람은 놀랍도록 잘 속거나 자신의 성적 관심사에 대해 깊이 부정하는 사람입니다. 어느 쪽이든, 스팸이 우리에게는 역겹거나 어리석어 보이지만, 그들에게는 흥미진진한 것입니다. 스패머들은 흥미롭게 들리지 않는다면 이런 말을 하지 않을 것입니다. 그리고 "다음 링크를 확인해 보세요"는 지금 스패머가 하는 말만큼 스팸 수신자에게 매력을 주지 못할 것입니다.

결과: 흥미로운 판매 홍보가 포함될 수 없다면, 스팸은 마케팅 수단으로서 효과가 떨어지고, 이를 사용하려는 기업은 줄어들 것입니다.
이것이 궁극적인 큰 승리입니다. 저는 더 이상 그런 것들을 보고 싶지 않아서 스팸 필터링 소프트웨어를 작성하기 시작했습니다.
하지만 스팸 필터링에 충분히 능숙해진다면 스팸은 더 이상 작동하지 않을 것이고, 스패머는 실제로 스팸 발송을 중단할 것입니다.
---
소프트웨어에서 법률에 이르기까지 스팸과의 싸움에 대한 모든 접근 방식 중에서, 저는 베이즈 필터링이 가장 효과적일 것이라고 믿습니다. 하지만 저는 또한 더 다양한 종류의 스팸 방지 노력을 기울일수록 더 좋다고 생각합니다. 왜냐하면 스패머를 제약하는 어떤 조치라도 필터링을 더 쉽게 만드는 경향이 있기 때문입니다.
그리고 콘텐츠 기반 필터링의 세계 내에서도, 동시에 다양한 종류의 소프트웨어가 사용되는 것이 좋은 일이라고 생각합니다. 필터가 많을수록 스패머가 필터를 통과하도록 스팸을 조정하기 더 어려울 것입니다.

### 부록: 필터링 예시
여기에 이 글을 쓰는 동안 도착한 스팸의 예시가 있습니다. 이 스팸에서 가장 흥미로운 15개 단어는 다음과 같습니다.
`qvp0045`
`indira`
`mx-05`
`intimail`
`$7500`
`freeyankeedom`
`cdo`
`bluefoxmedia`
`jpg`
`unsecured`
`platinum`
`3d0`
`qves`
`7c5`
`7c266675`

이 단어들은 헤더와 메시지 본문에서 나온 것들이 섞여 있는데, 이는 스팸의 전형적인 특징입니다. 또한 스팸의 전형적인 특징은 이 단어들 각각이 제 데이터베이스에서 .99의 스팸 확률을 가지고 있다는 것입니다. 사실 .99의 확률을 가진 단어가 15개 이상이며, 이들은 단지 처음 보이는 15개입니다.

불행히도 이 이메일은 베이즈 정리의 사용에 대한 지루한 예시가 됩니다. 다양한 흥미로운 확률을 보려면 실제로 매우 이례적인 스팸을 보아야 합니다.
이 스팸에서 가장 흥미로운 15개 단어와 그 확률은 다음과 같습니다.
```
madam           0.99
promotion       0.99
republic        0.99
shortest        0.047225013
mandatory       0.047225013
standardization 0.07347802
sorry           0.08221981
supported       0.09019077
people's        0.09019077
enter           0.9075001
quality         0.8921298
organization    0.12454646
investment      0.8568143
very            0.14758544
valuable        0.82347786
```
이번에는 증거가 좋은 것과 나쁜 것이 섞여 있습니다. "shortest"와 같은 단어는 "madam"이나 "promotion"과 같은 단어가 유죄를 나타내는 것만큼이나 무해함을 나타내는 증거입니다. 하지만 여전히 유죄 가능성이 더 강합니다. 베이즈 정리에 따라 이 숫자들을 결합하면 결과 확률은 .9027입니다.

"Madam"은 분명히 "Dear Sir or Madam"으로 시작하는 스팸에서 온 것입니다. 흔한 것은 아니지만, 제 합법적인 이메일에는 "madam"이라는 단어가 `결코` 나타나지 않으며, 모든 것은 비율에 달려 있습니다.
"Republic"은 나이지리아 사기 이메일에 자주 나타나고, 한국과 남아프리카 공화국을 언급하는 스팸에도 한두 번 나타나기 때문에 높은 점수를 받습니다.
이것이 이 스팸을 식별하는 데 도움이 되는 것이 우연이라고 말할 수도 있습니다. 하지만 스팸 확률을 조사하면서 이런 우연이 많다는 것을 발견했으며, 그들은 잘못된 방향이 아니라 올바른 방향으로 상황을 이끄는 기묘한 경향이 있습니다.
이 경우, "Republic"이라는 단어가 나이지리아 사기 이메일과 이 스팸에 나타나는 것이 전적으로 우연은 아닙니다. 덜 개발된 국가와 관련된 의심스러운 사업 제안들이 많으며, 이들은 그들이 공화국임을 명시적으로(왜냐하면 그렇지 않기 때문에) 지정하는 이름을 가질 가능성이 더 높습니다[3].

반면에 "enter"는 진짜 오인입니다. 주로 구독 취소 지침에 나타나지만, 여기서는 완전히 무해한 방식으로 사용되었습니다. 다행히 통계적 접근 방식은 상당히 견고하며, 결과가 흔들리기 전까지는 상당한 오인을 용인할 수 있습니다.

비교를 위해, 여기 필터를 통과하는 드문 스팸의 예시가 있습니다. 왜일까요? 단순히 우연히도 제 실제 이메일에 나타나는 단어로 가득 차 있기 때문입니다.
```
perl       0.01
python     0.01
tcl        0.01
scripting  0.01
morris     0.01
graham     0.01491078
guarantee  0.9762507
cgi        0.9734398
paul       0.027040077
quite      0.030676773
pop3       0.042199217
various    0.06080265
prices     0.9359873
managed    0.06451222
difficult  0.071706355
```
여기에는 몇 가지 좋은 소식이 있습니다. 첫째, 이 메일은 프로그래밍 언어를 전문으로 하지 않고 모리스(Morris)라는 좋은 친구가 없는 사람의 필터를 통과하지 못했을 것입니다. 일반 사용자에게는 여기 상위 5개 단어 모두 중립적이며 스팸 확률에 기여하지 않을 것입니다.
둘째, 단어 쌍(아래 참조)을 기반으로 한 필터링이 이것을 잡아낼 수도 있다고 생각합니다: "cost effective", "setup fee", "money back" -- 매우 죄를 입증하는 내용입니다. 그리고 물론 그들이 저에게(또는 제가 속한 네트워크에) 계속 스팸을 보낸다면 "Hostex" 자체는 스팸 용어로 인식될 것입니다.

마지막으로, 여기 무해한 이메일이 있습니다.
가장 흥미로운 15개 단어는 다음과 같습니다.
```
continuation  0.01
describe      0.01
continuations 0.01
example       0.033600237
programming   0.05214485 
i'm           0.055427782
examples      0.07972858 
color         0.9189189  
localhost     0.09883721
hi            0.116539136
california    0.84421706
same          0.15981844
spot          0.1654587
us-ascii      0.16804294
what          0.19212411
```
여기 있는 대부분의 단어들은 이 메일이 무해한 메일임을 나타냅니다.
두 개의 의심스러운 단어가 있는데, "color"(스패머는 컬러 글꼴을 좋아합니다)와 "California"(추천서와 양식 메뉴에 나타납니다)입니다. 하지만 이들은 "continuation"이나 "example"과 같은 명백히 무해한 단어들을 상쇄하기에는 충분하지 않습니다.

"describe"가 그렇게 철저히 무해하게 평가되는 것은 흥미롭습니다. 제 4000개의 스팸 중 단 하나도 나타나지 않았습니다. 데이터는 그런 놀라움으로 가득 차 있습니다. 스팸 텍스트를 분석할 때 배우는 것 중 하나는 스패머가 작동하는 언어의 범위가 얼마나 좁은지입니다. 이러한 사실과 개별 사용자의 메일의 특징적인 어휘가 베이즈 필터링을 좋은 선택으로 만듭니다.

### 부록: 추가 아이디어
제가 아직 시도하지 않은 한 가지 아이디어는 개별 단어가 아니라 단어 쌍, 또는 심지어 세 개 단어의 조합을 기반으로 필터링하는 것입니다.
이는 확률에 대한 훨씬 더 명확한 추정치를 제공할 것입니다.
예를 들어, 현재 제 데이터베이스에서 "offers"라는 단어의 확률은 .96입니다. 단어 쌍을 기반으로 확률을 계산한다면 "special offers"와 "valuable offers"는 .99의 확률을 가질 것이고, 예를 들어 "approach offers"(예: "this approach offers")는 .1 이하의 확률을 가질 것입니다.

제가 이것을 하지 않은 이유는 개별 단어를 기반으로 하는 필터링이 이미 너무 잘 작동하기 때문입니다. 하지만 이는 스팸을 탐지하기가 더 어려워지면 필터를 더 강화할 여지가 있다는 것을 의미합니다.
(흥미롭게도, 단어 쌍을 기반으로 하는 필터는 사실상 역방향으로 실행되는 마르코프 체인(Markov-chain) 텍스트 생성기가 될 것입니다.)

특정 스팸 특징(예: 받는 사람 주소가 To: 필드에 없는 경우)은 물론 스팸을 인식하는 데 가치가 있습니다. 이 알고리즘에서는 이를 가상 단어(virtual words)로 취급하여 고려할 수 있습니다. 저는 아마도 미래 버전에서, 적어도 가장 심각한 스팸 지표 몇 가지에 대해서는 이렇게 할 것입니다. 특징 인식 스팸 필터는 많은 세부 사항에서 옳습니다. 그들에게 부족한 것은 증거를 결합하는 전체적인 원칙입니다.

스팸 특징을 인식하는 것보다 비스팸 특징을 인식하는 것이 더 중요할 수 있습니다. 오탐은 너무나 걱정스러운 문제이므로 특별한 조치를 요구합니다. 저는 아마도 미래 버전에서 오탐을 피하기 위해 특별히 설계된 두 번째 수준의 테스트를 추가할 것입니다. 메일이 이 두 번째 수준의 필터를 트리거하면 스팸 확률이 임계값을 초과하더라도 수락될 것입니다.
저는 이 두 번째 수준의 필터링이 베이즈 방식일 것으로 예상하지 않습니다.
그것은 필연적으로 임시방편일 뿐만 아니라 추측에 기반할 것입니다. 왜냐하면 오탐의 수가 패턴을 알아챌 만큼 충분히 많지 않을 것이기 때문입니다.
(백업 시스템이 주 시스템과 동일한 기술에 의존하지 않는 것이 어쨌든 좋습니다.)

제가 미래에 시도할 수 있는 또 다른 것은 이메일의 특정 부분에 특별한 주의를 기울이는 것입니다. 예를 들어, 현재 스팸의 약 95%는 당신이 방문하기를 원하는 사이트의 URL을 포함합니다. (나머지 5%는 당신에게 전화번호로 전화하거나, 이메일 또는 미국 우편 주소로 답장하거나, 몇몇 경우에는 특정 주식을 구매하도록 요청합니다.) 이러한 경우 URL만으로도 이메일이 스팸인지 여부를 거의 결정할 수 있습니다.

도메인 이름은 (독일어 이메일을 제외한) 이메일의 나머지 텍스트와 달리 종종 여러 단어가 붙어 있습니다. 일반적인 경우 계산 비용이 많이 들지만, 이들을 분해해 볼 가치가 있을 수 있습니다. 필터가 이전에 "xxxporn"이라는 토큰을 본 적이 없다면 개별 스팸 확률은 .4일 것입니다. 반면 "xxx"와 "porn"은 개별적으로 (제 말뭉치에서) 각각 .9889와 .99의 확률을 가지며, 결합된 확률은 .9998입니다.

스패머가 메시지 텍스트에서 유죄를 입증하는 단어를 사용하는 것을 점차적으로 중단하게 될 때 도메인 이름을 분해하는 것이 더 중요해질 것이라고 예상합니다. (IP 주소가 있는 URL은 물론 몇몇 시스템 관리자(sysadmins)의 메일을 제외하고는 극도로 유죄를 입증하는 신호입니다.)

스패머가 홍보하는 URL 목록을 협력적으로 유지하는 것이 좋은 아이디어일 수 있습니다. 악의적이거나 무능한 제출을 방지하기 위해 래프 레비앙(Raph Levien)이 연구한 유형의 신뢰 측정법(trust metric)이 필요하겠지만, 그런 것이 있다면 모든 필터링 소프트웨어에 도움이 될 것입니다. 또한 보이콧의 편리한 근거가 될 수도 있습니다.

의심스러운 URL을 테스트하는 또 다른 방법은 사용자가 해당 URL이 언급된 이메일을 보기 전에 크롤러(crawler)를 보내 사이트를 살펴보는 것입니다. 베이즈 필터를 사용하여 이메일을 평가하는 것처럼 사이트를 평가할 수 있으며, 사이트에서 발견된 모든 것을 이메일이 스팸일 확률을 계산하는 데 포함할 수 있습니다. 리다이렉션(redirect)으로 이어지는 URL은 물론 특히 의심스러울 것입니다.

제가 정말 좋은 아이디어라고 생각하는 한 가지 협력 프로젝트는 거대한 스팸 말뭉치를 축적하는 것입니다. 크고 깨끗한 말뭉치는 베이즈 필터링이 잘 작동하도록 하는 핵심입니다. 베이즈 필터는 실제로 이 말뭉치를 입력으로 사용할 수 있습니다. 하지만 그러한 말뭉치는 다른 종류의 필터에도 유용할 것입니다. 테스트하는 데 사용될 수 있기 때문입니다.
그러한 말뭉치를 만드는 것은 몇 가지 기술적인 문제를 야기합니다. 물론 악의적이거나 무능한 제출을 방지하기 위한 신뢰 측정법이 필요할 것입니다. 또한 말뭉치에서 개인 정보(받는 사람 주소 및 참조 주소뿐만 아니라, 예를 들어 구독 취소 URL의 인수는 종종 받는 사람 주소를 인코딩함)를 지우는 방법도 필요할 것입니다. 이 프로젝트를 맡고 싶은 사람이 있다면, 세상에 좋은 일이 될 것입니다.

### 부록: 스팸 정의
저는 스팸이 무엇인지에 대한 대략적인 공감대가 있다고 생각하지만, 명확한 정의를 갖는 것이 유용할 것입니다. 스팸의 중앙 말뭉치를 만들거나 스팸 필터링 비율을 의미 있게 비교하려면 이렇게 해야 할 것입니다.
우선, 스팸은 원치 않는 상업성 이메일(unsolicited commercial email)이 아닙니다.
만약 제 이웃 중 누군가가 제가 오래된 랠리(Raleigh) 3단 자전거를 좋은 상태로 찾고 있다는 것을 듣고, 저에게 판매를 제안하는 이메일을 보냈다면, 저는 기뻐할 것입니다. 하지만 이 이메일은 상업적이고 원치 않는 것이 될 것입니다. 스팸의 정의적인 특징(사실 그 존재 이유)은 그것이 원치 않는 것이 아니라 자동화된 것이라는 점입니다.
스팸이 보통 상업적인 것이라는 점도 단지 부수적인 것입니다.
예를 들어, 누군가 어떤 정치적 대의를 지지하기 위해 대량 이메일을 보내기 시작했다면, 그것은 포르노 사이트를 홍보하는 이메일만큼이나 스팸일 것입니다.

저는 스팸을 `원치 않는 자동 이메일(unsolicited automated email)`로 정의할 것을 제안합니다.
따라서 이 정의는 많은 법적 스팸 정의에는 포함되지 않는 일부 이메일을 포함합니다. 로비스트의 영향을 받은 것으로 추정되는 스팸의 법적 정의는 수신자와 "기존 관계"가 있는 회사에서 보낸 메일을 제외하는 경향이 있습니다. 그러나 회사에서 무언가를 구매하는 것이 해당 회사로부터 지속적인 이메일을 요청하는 것을 의미하지는 않습니다.
제가 온라인 상점에서 무언가를 주문한 다음 그들이 저에게 스팸을 계속 보낸다면, 그것은 여전히 스팸입니다.

스팸을 보내는 회사들은 종종 "구독 취소" 방법을 제공하거나, 스팸 수신을 중단하려면 사이트로 가서 "계정 환경설정"을 변경하라고 요청합니다. 이것만으로는 메일이 스팸이 아닌 것이 되지 않습니다. 옵트아웃(opt out)하지 않는 것이 옵트인(opt in)하는 것과 같지 않습니다. 수신자가 명확하게 표시된 상자(기본값은 '아니오'였음)에 이메일 수신을 명시적으로 체크하지 않았다면, 그것은 스팸입니다.

일부 비즈니스 관계에서는 특정 종류의 메일을 암묵적으로 요청하는 경우도 있습니다. 온라인으로 주문할 때, 저는 영수증과 주문 배송 알림을 암묵적으로 요청한다고 생각합니다.
베리사인(Verisign)이 도메인 이름 만료 경고 메일을 보내는 것은 신경 쓰지 않습니다 (적어도 그들이 실제 등록기관(registrar)이라면 말이죠). 하지만 베리사인이 저에게 '전자상거래 웹사이트 구축을 위한 무료 가이드'를 제공하는 이메일을 보낸다면, 그것은 스팸입니다.

각주:
[1] 이 글의 예시는 믿거나 말거나 더 나은 접근성을 위해 Common Lisp로 번역되었습니다. 여기에 설명된 애플리케이션은 아직 출시되지 않은 새로운 Lisp 방언인 Arc를 테스트하기 위해 저희가 작성한 것입니다.
[2] 현재 백만 개의 스팸을 보내는 데 드는 가장 낮은 비용은 약 200달러인 것으로 보입니다. 이는 스팸당 0.0002달러로 매우 저렴합니다. 하지만 예를 들어 스팸의 95%를 필터링하면 스패머가 특정 잠재 고객에게 도달하는 데 드는 비용이 20배 증가할 것입니다. 이를 감당할 수 있을 만큼 마진이 큰 곳은 거의 없을 것입니다.
[3] 경험상, 한 국가의 이름 앞에 수식어가 많을수록 통치자는 더 부패한 경향이 있습니다. 예를 들어 '사회주의 인민 민주 공화국 X'와 같은 이름의 국가는 세상에서 가장 살고 싶지 않은 곳일 것입니다.

이 글의 초안을 읽어준 사라 할린(Sarah Harlin), 필터링에 대한 몇 가지 좋은 아이디어와 메일 인프라 구축을 도와준 다니엘 기핀(Daniel Giffin, 현재 아크 인터프리터도 개발 중), 스팸에 대해 많은 토론을 나눈 로버트 모리스(Robert Morris), 트레버 블랙웰(Trevor Blackwell), 에란 갓(Erann Gat), 신뢰 측정법에 대해 조언해 준 래프 레비앙(Raph Levien), 통계에 대해 조언해 준 칩 콜드웰(Chip Coldwell)과 샘 스타인골드(Sam Steingold)에게 감사합니다.

이 에세이와 다른 14개의 에세이는 "해커와 화가(Hackers & Painters)"에서 찾아볼 수 있습니다.

추가 정보: